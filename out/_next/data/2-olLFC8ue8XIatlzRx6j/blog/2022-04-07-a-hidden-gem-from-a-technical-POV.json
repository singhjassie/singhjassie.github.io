{"pageProps":{"post":{"date":"Jul 8, 2022","title":"A hidden gem from a technical POV","slug":"2022-04-07-a-hidden-gem-from-a-technical-POV","author":"Dm Knght","content":"\r\n## How do you check for an update?\r\n\r\nThe answer is straightforward `sudo apt update`. It’s the default used in the Debian documentation (technically apt is different from apt-get and aptitude but the method is similar):\r\n\r\n[https://www.debian.org/doc/manuals/debian-faq/uptodate.en.html](https://www.debian.org/doc/manuals/debian-faq/uptodate.en.html)\r\n\r\n## So, how does it work ?\r\nThe user must open a terminal, type \"sudo apt update\", press enter,  enter the user password then press enter again.\r\nIn the previous versions of Parrot, we had an “update reminder” that launches `sudo apt update` from the menu, so the user just needed to click and type the password.\r\n\r\n![1](/assets/blog/a_hidden_gem/1.png)\r\n\r\nWe are going to the point where “apt update” runs:\r\n\r\n1. The tool parses the repository addresses from “source lists” (we’ll go into more depth later)\r\n2. “apt” connects to the repository and downloads index files (screenshot below)\r\n\r\n![2](/assets/blog/a_hidden_gem/2.png)\r\n\r\nThe downloaded data from the central repository is quite large (18.9 MB). For Debian, it should be more than 12MB. If you have a low-speed internet connection or limited bandwidth, this is not a nice thing.\r\n\r\nIt can also add repositories for other architectures (i386 for example), which cause more files to be downloaded, even going so far as to download over 30 MB. The more repositories you have, and the more architecture you have, the more data you have to spend. 30 MB is not very nice, huh?\r\n\r\nLuckily, if you downloaded the latest index files, you don’t have to download them again.\r\n\r\n![3](/assets/blog/a_hidden_gem/3.png)\r\n\r\nSo why and how? (We’ll into this later. For now, I would like to point out some problems :)\r\n\r\n1. The downloaded data is too big if you just want to know about available updates\r\n2. It’s slow (well, not really, but can we make it faster?)\r\n3. sudo password everytime. Can we just check for updates without it but at the same time not compromise security policies?\r\n\r\n## APT and repository address behind the scene\r\n\r\n[https://wiki.debian.org/DebianRepository/Format#Overview](https://wiki.debian.org/DebianRepository/Format#Overview)\r\n\r\n![4](/assets/blog/a_hidden_gem/4.png)\r\n\r\nFrom reading the documentation and screenshot above, it’s a little hard to understand. So let’s try with Parrot’s repository.\r\n\r\n![5](/assets/blog/a_hidden_gem/5.png)\r\n\r\nLet’s try with URL, I’m using [https://deb.parrot.sh/parrot](https://deb.parrot.sh/parrot)\r\n\r\n![6](/assets/blog/a_hidden_gem/6.png)\r\n\r\nWhere is the value “parrot” as “distribution”? Isn’t it a URL mapping? Well… yes, it’s in dist.\r\n![7](/assets/blog/a_hidden_gem/7.png)\r\n\r\nNow you can see “parrot”. But hold on, let me show you the “pool” first:\r\n\r\nWhat’s in “pool”? Only branches. What does it contain? It has everything about a package:\r\ncompiled deb files, source code, etc.\r\n\r\n![8](/assets/blog/a_hidden_gem/8.png)\r\n\r\n![9](/assets/blog/a_hidden_gem/9.png)\r\n\r\nLooks like “pool” is the most important thing on the repository. But why is there a “dists”?\r\n\r\nInside “dist” of distribution “parrot” (we’d like to call it a branch instead of distribution), there are component folders and 3 files:\r\n\r\n1. InRelease\r\n2. Release\r\n3. Release.gpg, which should be the GPG key\r\n\r\n![10](/assets/blog/a_hidden_gem/10.png)\r\n\r\nLet's see what it contains. First with *Release*:\r\n\r\n![11](/assets/blog/a_hidden_gem/11.png)\r\n\r\nAnd then *InRelease*:\r\n\r\n![12](/assets/blog/a_hidden_gem/12.png)\r\n\r\nThese 2 files look similar. The difference is as follows. *InRelease* also contains a GPG key-value, whereas *Release* has only regular metadata. So why do we have to read all of this? Either Release or InRelease has section Date.\r\n\r\n![13](/assets/blog/a_hidden_gem/13.png)\r\n\r\nBy assuming all files are generated every time the repository has a new update, we can use it to do checks for update.\r\n\r\nLet’s check the components in \"dists\". We have architectures, and in each architecture directory, we have files that look like this:\r\n\r\n![14](/assets/blog/a_hidden_gem/14.png)\r\n\r\nThe file Release doesn’t have much info.\r\n\r\n![15](/assets/blog/a_hidden_gem/15.png)\r\n\r\nMeanwhile, Packages contain everything about packages. It’s like you are using `apt show`:\r\n\r\n![16](/assets/blog/a_hidden_gem/16.png)\r\n\r\nWhat are these used for?\r\n\r\n1. Folder pool contains packages (compiled .deb, source code, debianize, etc).\r\n2. Folder \"dists\" contains metadata of packages.\r\n3. Release and InRelease contains core information: release date, architecture, etc. and a checksum of all Package files.\r\n4. All Package files in components contain information of packages: name,version, depends, etc. Basically it’s a database of `apt show`.\r\n\r\nWe need a method to use either Release or InRelease, which costs only 14KB to check for a new update.\r\n\r\n## A hidden apt spot in your system and the way to use it\r\n\r\nNow we know Packages files are basically a “database” of apt. So where is it in the system?\r\n\r\nIt’s at `/var/lib/apt/lists/`.\r\n\r\n![17](/assets/blog/a_hidden_gem/17.png)\r\n\r\nAgain, we have to reuse the source list:\r\n\r\n![18](/assets/blog/a_hidden_gem/18.png)\r\n\r\nFile names in this directory are like this (notice that <address> is converted to <domain>_<path>)<address>_<dists>_<distribution>_\r\nIn the screenshot, we can see many things:\r\n\r\n- InRelease: The metadata file.\r\n- The _Packages, which is the actual database, contains components in the name. By the keyword binary, we can assume it’s about compiled packages (.deb file), and we have source for “apt source” which should have a different name.\r\n- Each repository and each branch has a different InRelease file.\r\n\r\nNow we can fully understand the workflow of `sudo apt update`.\r\n\r\n1. Read the source list, parse addresses.\r\n2. Convert address to actual repository address, download InRelease (which contains a GPG key), and then all Packages files (which are much larger than only InRelease).\r\n3. Convert the actual URL to file name, save in `/var/lib/apt/lists/`.\r\n4. DO NOT download everything if the local file is the latest. I haven’t checked the source code of apt, but I assume it’s sort of checking “Date” in the InRelease file. Well, it’s easy and simple to understand.\r\n\r\nSo we are having everything we need. So, the scope of the update-reminder is:\r\n\r\n1. Only check if a new update is available. We do not compare packages to know what can be upgraded, what will be removed, etc…\r\n2. Save A LOT of network data (about 14KB for a branch/distribution, seriously?).\r\n3. Save A LOT of time by very small data to download (About 70 KB).\r\n4. In the update-reminder, I do parse the section Date and compare date, which should make the code do less comparison.\r\n\r\n![19](/assets/blog/a_hidden_gem/19.png)\r\n","image":"/assets/blog/a_hidden_gem/a_hidden_gem.png","description":"An overview of our updater"}},"__N_SSG":true}